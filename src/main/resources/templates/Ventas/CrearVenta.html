<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="index :: headGeneral">
</head>
<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <nav th:replace="index :: navGeneral"></nav>
        <aside th:replace="index :: asideGeneral"></aside>
      	
        <div class="content-wrapper">
            <section class="content">

                <div class="loader" id="pantallaCarga"></div>

                 <div class="container">
                    <form id="formVenta" name="formVenta" action="/Ventas/Guardar" method="GET">
                            
                        <div class="row m-2">
                            
                            
                            <input type="number" style="width:20%" class="m-1 form-control" id="dni" name="dni" placeholder="DNI">
                           

                            <input type="text" style="width: 30%;" class="m-1 form-control" id="nombres" name="nombres" placeholder="Nombres" readonly >
                            <input type="text" style="width: 30%;" class="m-1 form-control" id="apellidos" name="apellidos" placeholder="Apellidos" readonly >
                             
                            <button type="button" class="btn btn-success btn-sm"> 
                                Nuevo Cliente
                            </button>       
    
                        </div>
                        
                        <div class="row">

                            <input type="hidden" name="json_detalles" id="json_detalles" value="">

                                <div class="">
                                
                                    
                                    <div class="w-100"></div>
            
                                    <div class="col">
                                        <div class="row">
                                    
                                            <table id="detalles" class="table table-striped table-bordered table-condensed table-hover" style='background-color:#FFFFFF;'> 
                                                <thead >
                                                    <th width="6%" class="text-center">
                                                        <div> 
                                                            <input type="text" style="text-align: center" class="form-control" readonly   id="item" value="1">     
                                                        </div>    
                                                    </th>                                           
                                                    <th width="40%"> 
                                                    <!-- select2 select2-hidden-accessible selectpicker -->
                                                        <select class="form-control " onchange="cambioProducto()" name="codProducto" id="codProducto" >
                                                            <option value="-1">- Producto -</option>
                                                            <option  th:each="producto : ${listaProductos}" th:value="${producto.codProducto}" th:text="${producto.nombre}">
                                                            </option>
                            
                                                        </select>
                                                        
                                                    </th>                                 
                                                    <th width="10%">
                                                        <div > 
                                                            <input type="number"  class="form-control" value="0" readonly id="precioUnitario">     
                                                        </div>
                                                    </th>
                                                    <th width="15%" class="text-center">
                                                        <div>  
                                                            <input type="number" min="0"  value="0" class="form-control"  id="cantidad" onchange="cambioCantidad()" >     
                                                        </div>
                                
                                                    </th>
                                                    <th width="15%" class="text-center">
                                                        <div>  
                                                            <input type="text" class="form-control"  id="subTotal" readonly>     
                                                        </div>
                                
                                                    </th>


                                                    <th width="10%" class="text-center">
                                                        <div>
                                                            <button type="button" id="btnadddet"  
                                                                class="btn btn-success" onclick="agregarDetalle()" >
                                                                <i class="fas fa-plus"></i>
                                                                    Agregar
                                                            </button>
                                                        </div>      
                                                    
                                                    </th>                                            
                                                    
                                                </thead>
                                                
                                                
                                                <thead class="thead-default" style="background-color:#3c8dbc;color: #fff;">
                                                    <th  class="text-center">Ítem</th>                                        
                                                    <th >Producto</th>                                 
                                                    <th >Precio</th>
                                                    <th  class="text-center">Cantidad</th>
                                                    <th  class="text-center">SubTotal</th>
                                                    <th  class="text-center">Opciones</th>                                            
                                                    
                                                </thead>
                                                <tbody>
                                                    
                                                </tbody>
                                                <tfoot>
                                                    <tr>
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                        <td class="text-right fontSize11">
                                                            Total:
                                                        </td>
                                                        <td class="text-right fontSize11" id="totalMostrado"></td>
                                                        <td></td>
                                                        
                                                    </tr>
                                                </tfoot>
                                            </table>
                                            
            
                                        </div>
            
                                    </div>
            
                                    
                                    
                                </div>
            
                                
            

                        </div>
                        
                        <div class="row m-4">
    
                            <div class="col text-left">
                                <a class="btn btn-primary" href="">
                                    
                                    <i class="fas fa-backward"></i>
                                    Menú principal
                                </a>

                            </div>
                            <div class="col text-right">

                                <button class="btn btn-primary" type ="button" onclick="clickGuardar()">
                                    <i class="fas fa-save"></i>
                                    Guardar
                                </button>

                            </div>

                            

                        </div>
                        
                    </form>
                 </div>
               
            </section>
        </div>
       
        <footer th:replace="index :: footerGeneral"></footer>
    </div>
    <th:block  th:replace="index :: scriptGeneral"></th:block>
</body>

<script th:replace = "Layout/ValidatorJS :: validatorJS"></script>

<script>

    var listaProductos = [(${json_listaProductos})];

    var listaClientes = [(${json_listaClientes})];

    
    var listaDetalles = [];

    var productoSeleccionado;
    var cantidadSeleccionada = 0;

    
    $(document).ready(function(){
        iniciarIdentificadorClientes();
        $(".loader").fadeOut("slow");
    });


    function iniciarIdentificadorClientes() {
        
        setInterval(function(){
             
            dni = document.getElementById('dni').value;
            if(dni.length==8){
                lista = listaClientes.filter(element => element.dni == dni)
                if(lista.length>0){ //si lo encontró
                    clienteEncontrado = lista[0];
                    console.log(clienteEncontrado)
                    document.getElementById('nombres').value = clienteEncontrado.nombres;
                    document.getElementById('apellidos').value = clienteEncontrado.apellidos;
                }else{
                    document.getElementById('nombres').value = "";
                    document.getElementById('apellidos').value = "";
                }
                
            }

        }, 0700);
    
    
    }


    function clickGuardar(){
        msj = validarForm();
        if(msj!=""){
            alerta(msj);
            return;
        }
        document.formVenta.submit();
    }
    
    function validarForm(){
        limpiarEstilos(['dni','nombres']);

        msj = "";

        msj = validarTamañoMaximoYNulidad(msj,'dni',200,'DNI');
        msj = validarTamañoMaximoYNulidad(msj,'nombres',100,'Nombres y apellidos');
 

        return msj;

    }

    function cambioProducto(){

        codProductoSeleccionado = codProducto.value;
        prod = listaProductos.find(m => m.codProducto == codProductoSeleccionado);
        console.log(prod);

        productoSeleccionado = prod;
        document.getElementById('precioUnitario').value = productoSeleccionado.precioActual;

        actualizarSubTotal();

    }

    function cambioCantidad(){
        cantidadSeleccionada = document.getElementById('cantidad').value;
        actualizarSubTotal();
    }

    

    function actualizarSubTotal(){
        //console.log(productoSeleccionado.precioActual);
        //console.log(cantidadSeleccionada);
        
        document.getElementById('subTotal').value  = parseFloat(productoSeleccionado.precioActual) * parseFloat(cantidadSeleccionada); 

    }







    function actualizarTabla(){
            //funcion para poner el contenido de listaDetalles en la tabla
            //tambien actualiza el total
            //$('#detalles')
            total=0;
            //vaciamos la tabla
            for (let index = 100; index >=0; index--) {
                $('#fila'+index).remove();
            }
            cantidadElementos = 0;
            //insertamos en la tabla los nuevos elementos
            for (let item = 0; item < listaDetalles.length; item++) {
                element = listaDetalles[item];
                 
                total=total +parseFloat(element.subTotal);
                itemMasUno = item+1;
                

                var fila=      /* ht ml */
                            `<tr class="selected" id="fila`+item+`">               
                                <td style="text-align:center;">              
                                   <input type="text" class="form-control"   value="`+itemMasUno+`" readonly>
                                </td>             
                                <td> 
                                   <input type="text" class="form-control"   value="`+element.producto.nombre+`" readonly>
                                </td>             
                                <td> 
                                   <input type="text" class="form-control"   value="`+element.producto.precioActual+`" readonly>
                                </td>             
                                <td  style="text-align:right;">
                                   <input type="text" style="text-align:right;" class="form-control" value = "`+element.cantidad+`" readonly> 
                                </td>               

                                <td  style="text-align:right;">
                                   <input type="text" style="text-align:right;" class="form-control" value = "`+number_format(element.subTotal,2)+`" readonly> 
                                </td>               
                                         
                                <td style="text-align:center;">              
                                    <button type="button" class="btn btn-danger btn-xs" onclick="eliminardetalle(`+item+`);">
                                        <i class="fa fa-times" ></i>               
                                    </button>       
                                    <button type="button" class="btn btn-xs" onclick="editarDetalle(`+item+`);">
                                        <i class="fas fa-pen"></i>            
                                    </button>        
                                </td>               
                            </tr>         `;
    
    
                $('#detalles').append(fila); 
                cantidadElementos ++;
            }
            
            console.log(total);
            document.getElementById('totalMostrado').innerHTML = number_format(total,2);
            document.getElementById('json_detalles').value = JSON.stringify(listaDetalles);
            

             
            $('#item').val(cantidadElementos + 1);
            
           
    }


    function agregarDetalle(){
        msjError="";
        // VALIDAMOS 
        limpiarEstilos(['codProducto','cantidad']);

        
        msjError= validarPositividadYNulidad(msjError,'cantidad','Cantidad');
        msjError= validarSelect(msjError,'codProducto','-1','Producto');
    
        if(msjError!=""){
            alerta(msjError);
            return false;
        }

        itemActual = listaDetalles.length + 1;


        // FIN DE VALIDACIONES
  
            listaDetalles.push({
                item:itemActual,
                producto : productoSeleccionado,
                producto_codigo : productoSeleccionado.codProducto, //añado esto para el backend
                cantidad : document.getElementById('cantidad').value,
                subTotal : cantidad * parseFloat(productoSeleccionado.precioActual)

            });        
            
        actualizarTabla();
        
        document.getElementById('codProducto').value = "-1";
        document.getElementById('cantidad').value =  "0";
        precioUnitario.value = "0";
        subTotal.value = "0";
        cantidadSeleccionada = 0;
        
    }


        function consultarPorDNI(){

            msjError="";

            msjError = validarTamañoExacto(msjError,'DNI',8,'DNI');
            msjError = validarNulidad(msjError,'DNI','DNI');
            

            if(msjError!=""){
                alerta(msjError);
                return;
            }


            $(".loader").show();//para mostrar la pantalla de carga
            dni = document.getElementById('DNI').value;

            $.get('/ConsultarAPISunat/dni/'+dni,
            function(data)
            {     
                console.log("IMPRIMIENDO DATA como llegó:");
                
                data = JSON.parse(data);
                  
                console.log(data);
                persona = data.datos;

                alertaMensaje(data.mensaje,data.titulo,data.tipoWarning);

                if(data.ok==1){
                    document.getElementById('nombres').value   = persona.nombres; 
                    document.getElementById('apellidos').value =  persona.apellidoPaterno + " " + persona.apellidoMaterno;


                    

                }
             
                $(".loader").fadeOut("slow");
            }
            );
        }










 


</script>


</html>